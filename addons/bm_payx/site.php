<?phpdefined('IN_IA') or exit('Access Denied');class bm_payxModuleSite extends WeModuleSite{    public $weid;    public function __construct()    {        global $_W;        $this->weid = IMS_VERSION < 0.6 ? $_W['weid'] : $_W['uniacid'];    }    public function doWebdownload()    {        require_once 'download.php';    }    public function doWebEmployee()    {        global $_W, $_GPC;        load()->model('reply');        load()->func('tpl');        $weid = $_W['uniacid'];        $op   = !empty($_GPC['op']) ? $_GPC['op'] : 'display';        $id   = $_GPC['id'];        $mid  = $_GPC['mid'];        if ($op == 'post') {            if (!empty($_GPC['mid'])) {                $item = pdo_fetch("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE id='{$_GPC['mid']}' order by id desc");            }            $data = array(                'rid' => $id,                'weid' => $weid,                'name' => $_GPC['name'],                'from_user' => $_GPC['from_user'],                'createtime' => TIMESTAMP            );            if ($_W['ispost']) {                if (empty($_GPC['mid'])) {                    pdo_insert('bm_payx_employee', $data);                } else {                    pdo_update('bm_payx_employee', $data, array(                        "id" => $_GPC['mid']                    ));                }                message('更新成功', referer(), 'success');            }        } elseif ($op == 'display') {            $sql  = "SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid='{$weid}' and rid='{$id}' order by id desc";            $list = pdo_fetchAll($sql);        } elseif ($op == 'delete') {            pdo_delete("bm_payx_employee", array(                'id' => $_GPC['mid']            ));            message('删除成功', referer(), 'success');        }        include $this->template('employee');    }    public function doWebCard()    {        global $_W, $_GPC;        load()->model('reply');        load()->func('tpl');        $weid = $_W['uniacid'];        $op   = !empty($_GPC['op']) ? $_GPC['op'] : 'display';        $id   = $_GPC['id'];        $mid  = $_GPC['mid'];        if ($op == 'post') {            if (!empty($_GPC['mid'])) {                $item = pdo_fetch("SELECT * FROM " . tablename('bm_payx_card') . " WHERE id='{$_GPC['mid']}' order by id desc");            }            $data = array(                'rid' => $id,                'weid' => $weid,                'cardline' => $_GPC['cardline'],                'cardid' => $_GPC['cardid'],                'cardname' => $_GPC['cardname'],                'createtime' => TIMESTAMP            );            if ($_W['ispost']) {                if (empty($_GPC['mid'])) {                    pdo_insert('bm_payx_card', $data);                } else {                    pdo_update('bm_payx_card', $data, array(                        "id" => $_GPC['mid']                    ));                }                message('更新成功', referer(), 'success');            }        } elseif ($op == 'display') {            $sql  = "SELECT * FROM " . tablename('bm_payx_card') . " WHERE weid='{$weid}' and rid='{$id}' order by id desc";            $list = pdo_fetchAll($sql);        } elseif ($op == 'delete') {            pdo_delete("bm_payx_card", array(                'id' => $_GPC['mid']            ));            message('删除成功', referer(), 'success');        }        include $this->template('card');    }    public function doWebRed()    {        global $_W, $_GPC;        load()->model('reply');        load()->func('tpl');        $weid = $_W['uniacid'];        $op   = !empty($_GPC['op']) ? $_GPC['op'] : 'display';        $id   = $_GPC['id'];        $mid  = $_GPC['mid'];        if ($op == 'post') {            if (!empty($_GPC['mid'])) {                $item = pdo_fetch("SELECT * FROM " . tablename('bm_payx_red') . " WHERE id='{$_GPC['mid']}' order by id desc");            }            $data = array(                'rid' => $id,                'weid' => $weid,                'redline' => $_GPC['redline'],                'redlow' => $_GPC['redlow'],                'redhigh' => $_GPC['redhigh'],                'redrate' => $_GPC['redrate'],                'createtime' => TIMESTAMP            );            if ($_W['ispost']) {                if (empty($_GPC['mid'])) {                    pdo_insert('bm_payx_red', $data);                } else {                    pdo_update('bm_payx_red', $data, array(                        "id" => $_GPC['mid']                    ));                }                message('更新成功', referer(), 'success');            }        } elseif ($op == 'display') {            $sql  = "SELECT * FROM " . tablename('bm_payx_red') . " WHERE weid='{$weid}' and rid='{$id}' order by id desc";            $list = pdo_fetchAll($sql);        } elseif ($op == 'delete') {            pdo_delete("bm_payx_red", array(                'id' => $_GPC['mid']            ));            message('删除成功', referer(), 'success');        }        include $this->template('red');    }    public function doWebRecord()    {        global $_GPC, $_W;        checklogin();        load()->func('tpl');        $rid       = intval($_GPC['id']);        $condition = '';        if (!empty($_GPC['username'])) {            $condition .= " AND username like '%{$_GPC['username']}%' ";        }        if (!empty($_GPC['sign_time'])) {            $condition .= " AND sign_time = '%{$_GPC['username']}%' ";        }        if (empty($starttime) || empty($endtime)) {            $starttime = strtotime('-1 month');            $endtime   = TIMESTAMP;        }        if (!empty($_GPC['time'])) {            $starttime = strtotime($_GPC['time']['start']);            $endtime   = strtotime($_GPC['time']['end']) + 86399;            $condition .= " AND sign_time >= '{$starttime}' AND sign_time <= '{$endtime}' ";        }        $pindex      = max(1, intval($_GPC['page']));        $psize       = 20;        $list        = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_record') . " WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize);        $total       = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_record') . " WHERE rid = '$rid' ");        $pager       = pagination($total, $pindex, $psize);        $memberlist  = pdo_fetchall("SELECT distinct fromuser FROM " . tablename('bm_payx_record') . "  WHERE rid = '$rid' ");        $membertotal = count($memberlist);        include $this->template('record');    }    public function doWebWinner()    {        global $_GPC, $_W;        checklogin();        $rid       = intval($_GPC['id']);        $condition = '';        if (!empty($_GPC['username'])) {            $condition .= " AND username like '%{$_GPC['username']}%' ";        }        $pindex      = max(1, intval($_GPC['page']));        $psize       = 20;        $list        = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_winner') . " WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize);        $total       = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_winner') . " WHERE rid = '$rid' ");        $pager       = pagination($total, $pindex, $psize);        $memberlist  = pdo_fetchall("SELECT distinct from_user FROM " . tablename('bm_payx_winner') . "  WHERE rid = '$rid' ");        $membertotal = count($memberlist);        include $this->template('winner');    }    public function doWebPlay()    {        global $_GPC, $_W;        checklogin();        $rid   = intval($_GPC['id']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if ($reply['qrtype'] == 0) {            $list = pdo_fetchall("SELECT id,username as content,fromuser as from_user,'text' as type,sign_time as createtime,username as nickname,avatar FROM " . tablename('bm_payx_record') . " WHERE rid = '$rid' and play_status=0 ORDER BY id DESC");        } else {            $list = pdo_fetchall("SELECT id,username as content,fromuser as from_user,'text' as type,dateline as createtime,username as nickname,avatar FROM " . tablename('bm_payx_payed') . " WHERE rid = '$rid' and play_status=0 and status=1 ORDER BY id DESC");        }        include $this->template('play');    }    public function doWebAjaxsubmit()    {        global $_GPC, $_W;        $rid    = intval($_GPC['rid']);        $reply  = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        $result = $reply['play_status'];        echo $result;    }    public function doWebAddwinner()    {        global $_GPC, $_W;        checklogin();        $rid   = intval($_GPC['id']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if ($reply['qrtype'] == 0) {            $message = pdo_fetch("SELECT * FROM " . tablename('bm_payx_record') . " WHERE id = :id LIMIT 1", array(                ':id' => intval($_GPC['mid'])            ));        } else {            $message = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE id = :id LIMIT 1", array(                ':id' => intval($_GPC['mid'])            ));        }        if (empty($message)) {            message('抱歉，参数不正确！', '', 'error');        }        $data = array(            'rid' => $message['rid'],            'from_user' => $message['fromuser'],            'dateline' => TIMESTAMP,            'username' => $message['username'],            'avatar' => $message['avatar'],            'status' => 0        );        pdo_insert('bm_payx_winner', $data);        if ($reply['qrtype'] == 0) {            pdo_update('bm_payx_record', array(                'play_status' => 1,                'play_time' => TIMESTAMP            ), array(                'id' => intval($_GPC['mid'])            ));        } else {            pdo_update('bm_payx_payed', array(                'play_status' => 1,                'play_time' => TIMESTAMP            ), array(                'id' => intval($_GPC['mid'])            ));        }        $url          = $reply['urly'];        $template     = array(            'touser' => $message['fromuser'],            'template_id' => $reply['templateid'],            'url' => $url,            'topcolor' => "#7B68EE",            'data' => array(                'first' => array(                    'value' => urlencode('恭喜您在' . $_W['account']['name'] . '的大屏幕活动中得奖！'),                    'color' => "#743A3A"                ),                'keyword1' => array(                    'value' => urlencode($reply['awaremethod']),                    'color' => "#FF0000"                ),                'keyword2' => array(                    'value' => urlencode($reply['awaretime']),                    'color' => "#0000FF"                ),                'remark' => array(                    'value' => urlencode("感谢您的参与！"),                    'color' => "#008000"                )            )        );        $appid        = $_W['account']['key'];        $appsecret    = $_W['account']['secret'];        $url          = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $appid . '&secret=' . $appsecret;        $res          = $this->http_request($url);        $result       = json_decode($res, true);        $access_token = $result["access_token"];        $lasttime     = time();        $x            = $this->send_template_message(urldecode(json_encode($template)), $access_token);        $result       = array(            'errcode' => $x['errcode'],            'errmsg' => $x['errmsg'],            'msgid' => $x['msgid']        );        message('', '', 'success');    }    private function http_request($url, $data = null)    {        $curl = curl_init();        curl_setopt($curl, CURLOPT_URL, $url);        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);        if (!empty($data)) {            curl_setopt($curl, CURLOPT_POST, 1);            curl_setopt($curl, CURLOPT_POSTFIELDS, $data);        }        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);        $output = curl_exec($curl);        curl_close($curl);        return $output;    }    private function send_template_message($data, $access_token)    {        $url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" . $access_token;        $res = $this->http_request($url, $data);        return json_decode($res, true);    }    public function doWebGetaware()    {        global $_GPC, $_W;        checklogin();        $rid       = intval($_GPC['rid']);        $condition = '';        if (!empty($_GPC['username'])) {            $condition .= " AND username like '%{$_GPC['username']}%' ";        }        if (!empty($_GPC['id'])) {            $id = intval($_GPC['id']);            pdo_update('bm_payx_winner', array(                'status' => intval($_GPC['status'])            ), array(                'id' => $id            ));        }        $pindex      = max(1, intval($_GPC['page']));        $psize       = 20;        $list        = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_winner') . " WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize);        $total       = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_winner') . " WHERE rid = '$rid' ");        $pager       = pagination($total, $pindex, $psize);        $memberlist  = pdo_fetchall("SELECT distinct from_user FROM " . tablename('bm_payx_winner') . "  WHERE rid = '$rid' ");        $membertotal = count($memberlist);        include $this->template('winner');    }    public function doWebPayed()    {        global $_GPC, $_W;        checklogin();        $rid       = intval($_GPC['id']);        $iid       = intval($_GPC['iid']);        $op        = trim($_GPC['op']);        $condition = '';        if (!empty($_GPC['username'])) {            $condition .= " AND username like '%{$_GPC['username']}%' ";        }        if (!empty($_GPC['name'])) {            $condition .= " AND name like '%{$_GPC['name']}%' ";        }        if (!empty($_GPC['startdate'])) {            $condition .= " and date_format(FROM_UNIXTIME(dateline),'%Y-%m-%d')>='" . $_GPC['startdate'] . "' ";        }        if (!empty($_GPC['enddate'])) {            $condition .= " and date_format(FROM_UNIXTIME(dateline),'%Y-%m-%d')<='" . $_GPC['enddate'] . "' ";        }        if ($op == 'used') {            pdo_update('bm_payx_payed', array(                "status" => 2            ), array(                "id" => $iid            ));        } elseif ($op == 'payed') {            pdo_update('bm_payx_payed', array(                "status" => 1            ), array(                "id" => $iid            ));        } elseif ($op == 'unpayed') {            pdo_update('bm_payx_payed', array(                "status" => 0            ), array(                "id" => $iid            ));        } elseif ($op == 'get') {            pdo_update('bm_payx_payed', array(                "getstatus" => 1            ), array(                "id" => $iid            ));        } elseif ($op == 'unget') {            pdo_update('bm_payx_payed', array(                "getstatus" => 0            ), array(                "id" => $iid            ));        } elseif ($op == 'delete') {            pdo_delete('bm_payx_payed', array(                'id' => $iid            ));        }        $pindex       = max(1, intval($_GPC['page']));        $psize        = 20;        $list         = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE rid = '$rid' $condition ORDER BY id DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize);        $total        = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " WHERE rid = '$rid' $condition");        $totalsuccess = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('bm_payx_payed') . " WHERE rid = '$rid' and status>0 $condition");        $pager        = pagination($total, $pindex, $psize);        include $this->template('payed');    }    public function doMobileSign()    {        global $_W, $_GPC;        $rid       = trim($_GPC['rid']);        $reply     = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        if (time() > strtotime($reply['endtime'])) {            if (empty($reply['memo2'])) {                $msg = '对不起，活动已经于' . $reply['endtime'] . '结束，感谢您的参与！！！';            } else {                $msg = $reply['memo2'];            }            message($msg, $reply['url2'], 'success');        }        if (time() < strtotime($reply['starttime'])) {            if (empty($reply['memo1'])) {                $msg = '对不起，活动将于' . $reply['starttime'] . '开始，敬请期待！！！';            } else {                $msg = $reply['memo1'];            }            message($msg, $reply['url1'], 'success');        }        if (empty($_W['fans']['nickname'])) {            mc_oauth_userinfo();        }        if ($reply['pictype'] == 1) {            if ((empty($_W['fans']['follow'])) || ($_W['fans']['follow'] == 0)) {                header("Location: " . $reply['urlx']);                exit;            }        }        $from_user = $_W['fans']['openid'];        $rec       = pdo_fetch("select * from " . tablename('bm_payx_record') . " where rid= " . $rid . " and fromuser= '{$from_user}' order by sign_time desc");        if (!empty($rec)) {            $Date_1       = date("Y-m-d", time());            $Date_2       = date("Y-m-d", $rec['sign_time']);            $Date_List_a1 = explode("-", $Date_1);            $Date_List_a2 = explode("-", $Date_2);            $d1           = mktime(0, 0, 0, $Date_List_a1[1], $Date_List_a1[2], $Date_List_a1[0]);            $d2           = mktime(0, 0, 0, $Date_List_a2[1], $Date_List_a2[2], $Date_List_a2[0]);            $Days         = round(($d1 - $d2) / 3600 / 24);            if ($Days == 0) {                $msg = '感谢您的参与，每个人每天只可以签到一次哦！！！';                message($msg, $reply['urly'], 'success');            }        }        $insert = array(            'rid' => $rid,            'fromuser' => $from_user,            'username' => $_W['fans']['nickname'],            'avatar' => $_W['fans']['tag']['avatar'],            'sign_time' => $_W['timestamp'],            'credit' => $reply['n']        );        pdo_insert('bm_payx_record', $insert);        $user       = fans_search($from_user);        $sql_member = "SELECT a.uid FROM " . tablename('mc_mapping_fans') . " a inner join " . tablename('mc_members') . " b on a.uid=b.uid WHERE b.uniacid='{$_W['uniacid']}' and a.openid='{$from_user}'";        $uid        = pdo_fetchcolumn($sql_member);        mc_credit_update($uid, 'credit1', intval($reply['n']), array(            0 => 'system',            1 => '扫码签到送积分'        ));        $user = fans_search($from_user);        message($reply['memo'], $reply['urly'], 'success');    }    public function doMobilePay()    {        global $_W, $_GPC;        $rid   = trim($_GPC['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if (!empty($reply['headbg'])) {            $headbg = $_W['attachurl'] . "/" . $reply['headbg'];        } else {            $headbg = "http://img2.bitautoimg.com/uimg/mbt2014/cheyitong/images/user-center-bg.jpg";        }        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        if (time() > strtotime($reply['endtime'])) {            if (empty($reply['memo2'])) {                $msg = '对不起，活动已经于' . $reply['endtime'] . '结束，感谢您的参与！！！';            } else {                $msg = $reply['memo2'];            }            message($msg, $reply['url2'], 'success');        }        if (time() < strtotime($reply['starttime'])) {            if (empty($reply['memo1'])) {                $msg = '对不起，活动将于' . $reply['starttime'] . '开始，敬请期待！！！';            } else {                $msg = $reply['memo1'];            }            message($msg, $reply['url1'], 'success');        }        if (empty($_W['fans']['nickname'])) {            mc_oauth_userinfo();        }        if ($reply['pictype'] == 1) {            if ((empty($_W['fans']['follow'])) || ($_W['fans']['follow'] == 0)) {                header("Location: " . $reply['urlx']);                exit;            }        }        $op        = trim($_GPC['op']);        $qrmoney   = $_GPC['qrmoney'];        $from_user = $_W['fans']['openid'];        $qrtype    = $reply['qrtype'];        if (checksubmit('submit')) {            if ($op == 'post') {                if ($qrmoney < 0.01) {                    message('支付金额错误，请重新录入！', $this->createMobileUrl('show', array(                        'rid' => $rid,                        'from_user' => $from_user                    )), 'error');                }                $data = array(                    'rid' => $rid,                    'dateline' => TIMESTAMP,                    'clientOrderId' => TIMESTAMP . random(6, 1),                    'qrmoney' => $qrmoney,                    'status' => 0,                    'fromuser' => $from_user,                    'username' => $_W['fans']['nickname'],                    'avatar' => $_W['fans']['tag']['avatar'],                    'credit' => $reply['n'],                    'paycode' => random(6, 1)                );                pdo_insert('bm_payx_payed', $data);                $params = array(                    'tid' => $data['clientOrderId'],                    'ordersn' => $data['clientOrderId'],                    'title' => '扫码支付',                    'fee' => $data['qrmoney'],                    'user' => $from_user                );                $this->pay($params);                exit;            }        }        if ($reply['qrmoney'] <= 0) {            message('支付错误, 金额小于0');        }        if (!empty($reply['logo'])) {            $qrpicurl = $_W['attachurl'] . $reply['logo'];        } else {            $qrpicurl = $_W['attachurl'] . $reply['qrcode'];        }        if ($reply['qrinput'] == 1) {            include $this->template('show');        } else {            message('正在提交订单，请稍候', $this->createmobileurl('pay_exec', array(                'rid' => $rid,                'from_user' => $from_user            )), 'success');        }    }    public function doMobilePay_exec()    {        global $_W, $_GPC;        $rid       = trim($_GPC['rid']);        $from_user = trim($_GPC['from_user']);        $reply     = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        $data = array(            'rid' => $rid,            'dateline' => TIMESTAMP,            'clientOrderId' => TIMESTAMP . random(6, 1),            'qrmoney' => $reply['qrmoney'],            'status' => 0,            'fromuser' => $from_user,            'username' => $_W['fans']['nickname'],            'avatar' => $_W['fans']['tag']['avatar'],            'credit' => $reply['n'],            'paycode' => random(6, 1)        );        pdo_insert('bm_payx_payed', $data);        $params = array(            'tid' => $data['clientOrderId'],            'ordersn' => $data['clientOrderId'],            'title' => '扫码支付',            'fee' => $data['qrmoney'],            'user' => $from_user        );        $this->pay($params);    }    public function payResult($params)    {        global $_W, $_GPC;        $payed     = pdo_fetch("select * from " . tablename('bm_payx_payed') . " where clientOrderId = '{$params['tid']}'");        $reply     = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $payed['rid']        ));        $employees = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and rid = :rid ORDER BY `id` DESC", array(            ':weid' => $reply['weid'],            ':rid' => $payed['rid']        ));        if ($params['result'] == 'success' && $params['type'] == 'alipay' && $params['from'] == 'notify' && $payed['paytype'] == 2) {            $url = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(                'cid' => $payed['clientOrderId']            ));            header('Location: ' . $url);            exit;        }        if ($params['result'] == 'success' && $params['type'] == 'alipay' && $params['from'] == 'notify' && $payed['paytype'] < 2) {            pdo_update('bm_payx_payed', array(                "status" => 1,                "paytype" => 2,                "paytime" => TIMESTAMP            ), array(                "clientOrderId" => $params['tid']            ));            $urlrpt       = $_W['siteroot'] . 'app/' . $this->createMobileUrl('paycheck', array(                'cid' => $payed['clientOrderId']            ));            $template     = array(                'touser' => $reply['openid'],                'template_id' => $reply['templateid1'],                'url' => $urlrpt,                'topcolor' => "#7B68EE",                'data' => array(                    'first' => array(                        'value' => urlencode($reply['title'] . '有客户使用支付宝完成扫码支付！'),                        'color' => "#743A3A"                    ),                    'keyword1' => array(                        'value' => urlencode($payed['clientOrderId']),                        'color' => "#FF0000"                    ),                    'keyword2' => array(                        'value' => urlencode(date('Y-m-d H:i:s', time())),                        'color' => "#0000FF"                    ),                    'keyword3' => array(                        'value' => urlencode($payed['qrmoney']),                        'color' => "#0000FF"                    ),                    'remark' => array(                        'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $payed['username'] . "，点击详情查看账单！"),                        'color' => "#008000"                    )                )            );            $sql          = 'SELECT `key`,`secret` FROM ' . tablename('account_wechats') . ' WHERE `acid`=:acid';            $row          = pdo_fetch($sql, array(                ':acid' => $reply['weid']            ));            $appid        = $row['key'];            $appsecret    = $row['secret'];            $url          = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $appid . '&secret=' . $appsecret;            $res          = $this->http_request($url);            $result       = json_decode($res, true);            $access_token = $result["access_token"];            $lasttime     = time();            $x            = $this->send_template_message(urldecode(json_encode($template)), $access_token);            foreach ($employees as $employee) {                $template = array(                    'touser' => $employee['from_user'],                    'template_id' => $reply['templateid1'],                    'url' => $urlrpt,                    'topcolor' => "#7B68EE",                    'data' => array(                        'first' => array(                            'value' => urlencode($reply['title'] . '有客户使用支付宝完成扫码支付！'),                            'color' => "#743A3A"                        ),                        'keyword1' => array(                            'value' => urlencode($payed['clientOrderId']),                            'color' => "#FF0000"                        ),                        'keyword2' => array(                            'value' => urlencode(date('Y-m-d H:i:s', time())),                            'color' => "#0000FF"                        ),                        'keyword3' => array(                            'value' => urlencode($payed['qrmoney']),                            'color' => "#0000FF"                        ),                        'remark' => array(                            'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $payed['username'] . "，点击详情查看账单！"),                            'color' => "#008000"                        )                    )                );                $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);            }            if ($reply['red'] == 1) {                $reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = " . $payed['rid'] . " and redline <= " . $payed['qrmoney'] . " order by redline desc limit 1");                if (!empty($reds)) {                    if ($payed[qrmoney] >= $reds['redline']) {                        $rate      = intval($reds['redrate']);                        $ratex     = 100 - $rate;                        $prize_arr = array(                            '0' => array(                                'id' => 1,                                'prize' => 'o',                                'v' => $rate                            ),                            '1' => array(                                'id' => 2,                                'prize' => 'x',                                'v' => $ratex                            )                        );                        $arr       = array();                        foreach ($prize_arr as $key => $val) {                            $arr[$val['id']] = $val['v'];                        }                        $ridx       = $this->get_rand($arr);                        $res        = array();                        $res['yes'] = $prize_arr[$ridx - 1]['prize'];                        unset($prize_arr[$ridx - 1]);                        shuffle($prize_arr);                        for ($i = 0; $i < count($prize_arr); $i++) {                            $pr[] = $prize_arr[$i]['prize'];                        }                        $res['no'] = $pr;                        if ($res['yes'] == 'o') {                            if ($reds['redlow'] == $reds['redhigh']) {                                $red = $reds['redlow'];                            } else {                                $red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);                                $red = round($red, 2);                            }                            $url                  = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';                            $pars                 = array();                            $pars['nonce_str']    = random(32);                            $pars['mch_billno']   = $_W['cache']['unisetting:1']['payment']['wechat']['mchid'] . date("Ymd") . random(10, 1);                            $pars['mch_id']       = $_W['cache']['unisetting:1']['payment']['wechat']['mchid'];                            $pars['wxappid']      = $appid;                            $pars['send_name']    = $reply['title'];                            $pars['re_openid']    = $payed['fromuser'];                            $pars['total_amount'] = $red * 100;                            $pars['total_num']    = 1;                            $pars['wishing']      = '感谢您的光临！送上红包，敬请请笑纳！';                            $pars['client_ip']    = '203.195.157.41';                            $pars['act_name']     = $reply['title'];                            $pars['remark']       = "扫码支付送红包,订单号为" . $payed['clientOrderId'];                            ksort($pars, SORT_STRING);                            $string1 = '';                            foreach ($pars as $k => $v) {                                $string1 .= "{$k}={$v}&";                            }                            $string1 .= "key=" . $_W['cache']['unisetting:1']['payment']['wechat']['apikey'];                            $pars['sign']              = strtoupper(md5($string1));                            $xml                       = array2xml($pars);                            $extras                    = array();                            $extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/rootca.pem' . $reply['weid'];                            $extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $reply['weid'];                            $extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_key.pem' . $reply['weid'];                            $procResult                = null;                            load()->func('communication');                            $resp = ihttp_request($url, $xml, $extras);                            if (is_error($resp)) {                                $procResult = $resp;                            } else {                                $arr = json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);                                $xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];                                $dom = new \DOMDocument();                                if ($dom->loadXML($xml)) {                                    $xpath = new \DOMXPath($dom);                                    $code  = $xpath->evaluate('string(//xml/return_code)');                                    $ret   = $xpath->evaluate('string(//xml/result_code)');                                    if (strtolower($code) == 'success' && strtolower($ret) == 'success') {                                        $procResult = array(                                            'errno' => 0,                                            'error' => 'success'                                        );                                    } else {                                        $error      = $xpath->evaluate('string(//xml/err_code_des)');                                        $procResult = array(                                            'errno' => -2,                                            'error' => $error                                        );                                    }                                } else {                                    $procResult = array(                                        'errno' => -1,                                        'error' => '未知错误'                                    );                                }                            }                            pdo_update('bm_payx_payed', array(                                'red' => $red,                                "redtime" => TIMESTAMP,                                "redstatus" => $procResult['errno'],                                "redmemo" => $procResult['error']                            ), array(                                "clientOrderId" => $params['tid']                            ));                        } else {                            $red = 0;                        }                    }                }            }            if ($reply['card'] == 1) {                $reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = " . $payed['rid'] . " and cardline <= " . $payed['qrmoney'] . " order by cardline desc limit 1");                if (!empty($reds)) {                    if ($payed[qrmoney] >= $reds['cardline']) {                        $data = array(                            'touser' => $payed['fromuser'],                            'wxcard' => array(                                'card_id' => $reds['cardid']                            ),                            'msgtype' => 'wxcard'                        );                        load()->func('communication');                        $postUrl    = 'https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token=' . $access_token;                        $json_data  = json_encode($data);                        $result     = ihttp_post($postUrl, urldecode($json_data));                        $procResult = @json_decode($result['content'], true);                        $insert     = array(                            'cardid' => $reds['cardid'],                            'cardname' => $reds['cardname'],                            'cardtime' => TIMESTAMP,                            'cardstatus' => $procResult['errcode'],                            'cardmemo' => $procResult['errmsg']                        );                        pdo_update('bm_payx_payed', $insert, array(                            "clientOrderId" => $params['tid']                        ));                    }                }            }            $fansuid     = pdo_fetchcolumn("select uid from " . tablename('mc_mapping_fans') . " where openid='{$payed['fromuser']}'");            $fanscredit1 = pdo_fetchcolumn("select credit1 from " . tablename('mc_members') . " where uid='{$fansuid}'");            $credit1x    = $fanscredit1 + $reply['n'];            pdo_update('mc_members', array(                'credit1' => $credit1x            ), array(                "uid" => $fansuid            ));            $url      = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(                'cid' => $payed['clientOrderId']            ));            $template = array(                'touser' => $payed['fromuser'],                'template_id' => $reply['templateid1'],                'url' => $url,                'topcolor' => "#7B68EE",                'data' => array(                    'first' => array(                        'value' => urlencode('感谢您使用' . $reply['title'] . '扫码支付！'),                        'color' => "#743A3A"                    ),                    'keyword1' => array(                        'value' => urlencode($payed['clientOrderId']),                        'color' => "#FF0000"                    ),                    'keyword2' => array(                        'value' => urlencode(date('Y-m-d H:i:s', time())),                        'color' => "#0000FF"                    ),                    'keyword3' => array(                        'value' => urlencode($payed['qrmoney']),                        'color' => "#0000FF"                    ),                    'remark' => array(                        'value' => urlencode("付款码：" . $payed['paycode'] . "，点击详情查看账单！"),                        'color' => "#008000"                    )                )            );            $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);        }        if ($params['result'] == 'success' && $params['type'] == 'credit' && $params['from'] == 'return') {            pdo_update('bm_payx_payed', array(                "status" => 1,                "paytype" => 1,                "paytime" => TIMESTAMP            ), array(                "clientOrderId" => $params['tid']            ));            $urlrpt       = $_W['siteroot'] . 'app/' . $this->createMobileUrl('paycheck', array(                'cid' => $payed['clientOrderId']            ));            $template     = array(                'touser' => $reply['openid'],                'template_id' => $reply['templateid1'],                'url' => $urlrpt,                'topcolor' => "#7B68EE",                'data' => array(                    'first' => array(                        'value' => urlencode($_W['account']['name'] . '有客户使用余额完成扫码支付！'),                        'color' => "#743A3A"                    ),                    'keyword1' => array(                        'value' => urlencode($payed['clientOrderId']),                        'color' => "#FF0000"                    ),                    'keyword2' => array(                        'value' => urlencode(date('Y-m-d H:i:s', time())),                        'color' => "#0000FF"                    ),                    'keyword3' => array(                        'value' => urlencode($payed['qrmoney']),                        'color' => "#0000FF"                    ),                    'remark' => array(                        'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $_W['fans']['nickname'] . "，点击详情查看账单！"),                        'color' => "#008000"                    )                )            );            $appid        = $_W['account']['key'];            $appsecret    = $_W['account']['secret'];            $url          = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $appid . '&secret=' . $appsecret;            $res          = $this->http_request($url);            $result       = json_decode($res, true);            $access_token = $result["access_token"];            $lasttime     = time();            $x            = $this->send_template_message(urldecode(json_encode($template)), $access_token);            foreach ($employees as $employee) {                $template = array(                    'touser' => $employee['from_user'],                    'template_id' => $reply['templateid1'],                    'url' => $urlrpt,                    'topcolor' => "#7B68EE",                    'data' => array(                        'first' => array(                            'value' => urlencode($_W['account']['name'] . '有客户使用余额完成扫码支付！'),                            'color' => "#743A3A"                        ),                        'keyword1' => array(                            'value' => urlencode($payed['clientOrderId']),                            'color' => "#FF0000"                        ),                        'keyword2' => array(                            'value' => urlencode(date('Y-m-d H:i:s', time())),                            'color' => "#0000FF"                        ),                        'keyword3' => array(                            'value' => urlencode($payed['qrmoney']),                            'color' => "#0000FF"                        ),                        'remark' => array(                            'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $_W['fans']['nickname'] . "，点击详情查看账单！"),                            'color' => "#008000"                        )                    )                );                $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);            }            if ($reply['red'] == 1) {                $reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = " . $payed['rid'] . " and redline <= " . $payed['qrmoney'] . " order by redline desc limit 1");                if (!empty($reds)) {                    if ($payed[qrmoney] >= $reds['redline']) {                        $rate      = intval($reds['redrate']);                        $ratex     = 100 - $rate;                        $prize_arr = array(                            '0' => array(                                'id' => 1,                                'prize' => 'o',                                'v' => $rate                            ),                            '1' => array(                                'id' => 2,                                'prize' => 'x',                                'v' => $ratex                            )                        );                        $arr       = array();                        foreach ($prize_arr as $key => $val) {                            $arr[$val['id']] = $val['v'];                        }                        $ridx       = $this->get_rand($arr);                        $res        = array();                        $res['yes'] = $prize_arr[$ridx - 1]['prize'];                        unset($prize_arr[$ridx - 1]);                        shuffle($prize_arr);                        for ($i = 0; $i < count($prize_arr); $i++) {                            $pr[] = $prize_arr[$i]['prize'];                        }                        $res['no'] = $pr;                        if ($res['yes'] == 'o') {                            if ($reds['redlow'] == $reds['redhigh']) {                                $red = $reds['redlow'];                            } else {                                $red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);                                $red = round($red, 2);                            }                            $setting              = uni_setting($_W['uniacid'], array(                                'payment'                            ));                            $wechat               = $setting['payment']['wechat'];                            $url                  = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';                            $pars                 = array();                            $pars['nonce_str']    = random(32);                            $pars['mch_billno']   = $wechat['mchid'] . date("Ymd") . random(10, 1);                            $pars['mch_id']       = $wechat['mchid'];                            $pars['wxappid']      = $_W['account']['key'];                            $pars['send_name']    = $_W['account']['name'];                            $pars['re_openid']    = $_W['fans']['openid'];                            $pars['total_amount'] = $red * 100;                            $pars['total_num']    = 1;                            $pars['wishing']      = '感谢您的光临！送上红包，敬请请笑纳！';                            $pars['client_ip']    = '203.195.157.41';                            $pars['act_name']     = $reply['title'];                            $pars['remark']       = "扫码支付送红包,订单号为" . $payed['clientOrderId'];                            ksort($pars, SORT_STRING);                            $string1 = '';                            foreach ($pars as $k => $v) {                                $string1 .= "{$k}={$v}&";                            }                            $string1 .= "key=" . $wechat['apikey'];                            $pars['sign']              = strtoupper(md5($string1));                            $xml                       = array2xml($pars);                            $extras                    = array();                            $extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];                            $extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];                            $extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];                            $procResult                = null;                            load()->func('communication');                            $resp = ihttp_request($url, $xml, $extras);                            if (is_error($resp)) {                                $procResult = $resp;                            } else {                                $arr = json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);                                $xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];                                $dom = new \DOMDocument();                                if ($dom->loadXML($xml)) {                                    $xpath = new \DOMXPath($dom);                                    $code  = $xpath->evaluate('string(//xml/return_code)');                                    $ret   = $xpath->evaluate('string(//xml/result_code)');                                    if (strtolower($code) == 'success' && strtolower($ret) == 'success') {                                        $procResult = array(                                            'errno' => 0,                                            'error' => 'success'                                        );                                    } else {                                        $error      = $xpath->evaluate('string(//xml/err_code_des)');                                        $procResult = array(                                            'errno' => -2,                                            'error' => $error                                        );                                    }                                } else {                                    $procResult = array(                                        'errno' => -1,                                        'error' => '未知错误'                                    );                                }                            }                            pdo_update('bm_payx_payed', array(                                'red' => $red,                                "redtime" => TIMESTAMP,                                "redstatus" => $procResult['errno'],                                "redmemo" => $procResult['error']                            ), array(                                "clientOrderId" => $params['tid']                            ));                        } else {                            $red = 0;                        }                    }                }            }            if ($reply['card'] == 1) {                $reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = " . $payed['rid'] . " and cardline <= " . $payed['qrmoney'] . " order by cardline desc limit 1");                if (!empty($reds)) {                    if ($payed[qrmoney] >= $reds['cardline']) {                        $data = array(                            'touser' => $_W['fans']['openid'],                            'wxcard' => array(                                'card_id' => $reds['cardid']                            ),                            'msgtype' => 'wxcard'                        );                        load()->func('communication');                        $url        = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $_W['account']['key'] . '&secret=' . $_W['account']['secret'];                        $ret        = ihttp_get($url);                        $auth       = @json_decode($ret['content'], true);                        $postUrl    = 'https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token=' . $auth['access_token'];                        $json_data  = json_encode($data);                        $result     = ihttp_post($postUrl, urldecode($json_data));                        $procResult = @json_decode($result['content'], true);                        $insert     = array(                            'cardid' => $reds['cardid'],                            'cardname' => $reds['cardname'],                            'cardtime' => TIMESTAMP,                            'cardstatus' => $procResult['errcode'],                            'cardmemo' => $procResult['errmsg']                        );                        pdo_update('bm_payx_payed', $insert, array(                            "clientOrderId" => $params['tid']                        ));                    }                }            }            $result   = mc_credit_update($_W['fans'][uid], 'credit1', $reply['n']);            $url      = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(                'cid' => $payed['clientOrderId']            ));            $template = array(                'touser' => $_W['fans']['openid'],                'template_id' => $reply['templateid1'],                'url' => $url,                'topcolor' => "#7B68EE",                'data' => array(                    'first' => array(                        'value' => urlencode('感谢您使用' . $_W['account']['name'] . '扫码支付！'),                        'color' => "#743A3A"                    ),                    'keyword1' => array(                        'value' => urlencode($payed['clientOrderId']),                        'color' => "#FF0000"                    ),                    'keyword2' => array(                        'value' => urlencode(date('Y-m-d H:i:s', time())),                        'color' => "#0000FF"                    ),                    'keyword3' => array(                        'value' => urlencode($payed['qrmoney']),                        'color' => "#0000FF"                    ),                    'remark' => array(                        'value' => urlencode("付款码：" . $payed['paycode'] . "，点击详情查看账单！"),                        'color' => "#008000"                    )                )            );            $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);            header('Location: ' . $url);            exit;        }        if ($params['result'] == 'success' && $params['from'] == 'notify') {            pdo_update('bm_payx_payed', array(                "status" => 1,                "paytime" => TIMESTAMP            ), array(                "clientOrderId" => $params['tid']            ));        }        if ($params['from'] == 'return') {            if ($params['result'] == 'success') {                $urlrpt       = $_W['siteroot'] . 'app/' . $this->createMobileUrl('paycheck', array(                    'cid' => $payed['clientOrderId']                ));                $template     = array(                    'touser' => $reply['openid'],                    'template_id' => $reply['templateid1'],                    'url' => $urlrpt,                    'topcolor' => "#7B68EE",                    'data' => array(                        'first' => array(                            'value' => urlencode($_W['account']['name'] . '有客户完成扫码支付！'),                            'color' => "#743A3A"                        ),                        'keyword1' => array(                            'value' => urlencode($payed['clientOrderId']),                            'color' => "#FF0000"                        ),                        'keyword2' => array(                            'value' => urlencode(date('Y-m-d H:i:s', time())),                            'color' => "#0000FF"                        ),                        'keyword3' => array(                            'value' => urlencode($payed['qrmoney']),                            'color' => "#0000FF"                        ),                        'remark' => array(                            'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $_W['fans']['nickname'] . "，点击详情查看账单！"),                            'color' => "#008000"                        )                    )                );                $appid        = $_W['account']['key'];                $appsecret    = $_W['account']['secret'];                $url          = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $appid . '&secret=' . $appsecret;                $res          = $this->http_request($url);                $result       = json_decode($res, true);                $access_token = $result["access_token"];                $lasttime     = time();                $x            = $this->send_template_message(urldecode(json_encode($template)), $access_token);                foreach ($employees as $employee) {                    $template = array(                        'touser' => $employee['from_user'],                        'template_id' => $reply['templateid1'],                        'url' => $urlrpt,                        'topcolor' => "#7B68EE",                        'data' => array(                            'first' => array(                                'value' => urlencode($_W['account']['name'] . '有客户完成扫码支付！'),                                'color' => "#743A3A"                            ),                            'keyword1' => array(                                'value' => urlencode($payed['clientOrderId']),                                'color' => "#FF0000"                            ),                            'keyword2' => array(                                'value' => urlencode(date('Y-m-d H:i:s', time())),                                'color' => "#0000FF"                            ),                            'keyword3' => array(                                'value' => urlencode($payed['qrmoney']),                                'color' => "#0000FF"                            ),                            'remark' => array(                                'value' => urlencode("付款码：" . $payed['paycode'] . "，客户昵称：" . $_W['fans']['nickname'] . "，点击详情查看账单！"),                                'color' => "#008000"                            )                        )                    );                    $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);                }                if ($reply['red'] == 1) {                    $reds = pdo_fetch("select * from " . tablename('bm_payx_red') . " where rid = " . $payed['rid'] . " and redline <= " . $payed['qrmoney'] . " order by redline desc limit 1");                    if (!empty($reds)) {                        if ($payed[qrmoney] >= $reds['redline']) {                            $rate      = intval($reds['redrate']);                            $ratex     = 100 - $rate;                            $prize_arr = array(                                '0' => array(                                    'id' => 1,                                    'prize' => 'o',                                    'v' => $rate                                ),                                '1' => array(                                    'id' => 2,                                    'prize' => 'x',                                    'v' => $ratex                                )                            );                            $arr       = array();                            foreach ($prize_arr as $key => $val) {                                $arr[$val['id']] = $val['v'];                            }                            $ridx       = $this->get_rand($arr);                            $res        = array();                            $res['yes'] = $prize_arr[$ridx - 1]['prize'];                            unset($prize_arr[$ridx - 1]);                            shuffle($prize_arr);                            for ($i = 0; $i < count($prize_arr); $i++) {                                $pr[] = $prize_arr[$i]['prize'];                            }                            $res['no'] = $pr;                            if ($res['yes'] == 'o') {                                if ($reds['redlow'] == $reds['redhigh']) {                                    $red = $reds['redlow'];                                } else {                                    $red = $reds['redlow'] + mt_rand() / mt_getrandmax() * ($reds['redhigh'] - $reds['redlow']);                                    $red = round($red, 2);                                }                                $setting              = uni_setting($_W['uniacid'], array(                                    'payment'                                ));                                $wechat               = $setting['payment']['wechat'];                                $url                  = 'https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack';                                $pars                 = array();                                $pars['nonce_str']    = random(32);                                $pars['mch_billno']   = $wechat['mchid'] . date("Ymd") . random(10, 1);                                $pars['mch_id']       = $wechat['mchid'];                                $pars['wxappid']      = $_W['account']['key'];                                $pars['send_name']    = $_W['account']['name'];                                $pars['re_openid']    = $_W['fans']['openid'];                                $pars['total_amount'] = $red * 100;                                $pars['total_num']    = 1;                                $pars['wishing']      = '感谢您的光临！送上红包，敬请请笑纳！';                                $pars['client_ip']    = '203.195.157.41';                                $pars['act_name']     = $reply['title'];                                $pars['remark']       = "扫码支付送红包,订单号为" . $payed['clientOrderId'];                                ksort($pars, SORT_STRING);                                $string1 = '';                                foreach ($pars as $k => $v) {                                    $string1 .= "{$k}={$v}&";                                }                                $string1 .= "key=" . $wechat['apikey'];                                $pars['sign']              = strtoupper(md5($string1));                                $xml                       = array2xml($pars);                                $extras                    = array();                                $extras['CURLOPT_CAINFO']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/rootca.pem' . $_W['uniacid'];                                $extras['CURLOPT_SSLCERT'] = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_cert.pem' . $_W['uniacid'];                                $extras['CURLOPT_SSLKEY']  = dirname(dirname(dirname(preg_replace('@\(.*\(.*$@', '', preg_replace('@\(.*\(.*$@', '', __FILE__))))) . '/addons/bm_payx/cert/apiclient_key.pem' . $_W['uniacid'];                                $procResult                = null;                                load()->func('communication');                                $resp = ihttp_request($url, $xml, $extras);                                if (is_error($resp)) {                                    $procResult = $resp;                                } else {                                    $arr = json_decode(json_encode((array) simplexml_load_string($resp['content'])), true);                                    $xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content'];                                    $dom = new \DOMDocument();                                    if ($dom->loadXML($xml)) {                                        $xpath = new \DOMXPath($dom);                                        $code  = $xpath->evaluate('string(//xml/return_code)');                                        $ret   = $xpath->evaluate('string(//xml/result_code)');                                        if (strtolower($code) == 'success' && strtolower($ret) == 'success') {                                            $procResult = array(                                                'errno' => 0,                                                'error' => 'success'                                            );                                        } else {                                            $error      = $xpath->evaluate('string(//xml/err_code_des)');                                            $procResult = array(                                                'errno' => -2,                                                'error' => $error                                            );                                        }                                    } else {                                        $procResult = array(                                            'errno' => -1,                                            'error' => '未知错误'                                        );                                    }                                }                                pdo_update('bm_payx_payed', array(                                    'red' => $red,                                    "redtime" => TIMESTAMP,                                    "redstatus" => $procResult['errno'],                                    "redmemo" => $procResult['error']                                ), array(                                    "clientOrderId" => $params['tid']                                ));                            } else {                                $red = 0;                            }                        }                    }                }                if ($reply['card'] == 1) {                    $reds = pdo_fetch("select * from " . tablename('bm_payx_card') . " where rid = " . $payed['rid'] . " and cardline <= " . $payed['qrmoney'] . " order by cardline desc limit 1");                    if (!empty($reds)) {                        if ($payed[qrmoney] >= $reds['cardline']) {                            $data = array(                                'touser' => $_W['fans']['openid'],                                'wxcard' => array(                                    'card_id' => $reds['cardid']                                ),                                'msgtype' => 'wxcard'                            );                            load()->func('communication');                            $url        = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $_W['account']['key'] . '&secret=' . $_W['account']['secret'];                            $ret        = ihttp_get($url);                            $auth       = @json_decode($ret['content'], true);                            $postUrl    = 'https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token=' . $auth['access_token'];                            $json_data  = json_encode($data);                            $result     = ihttp_post($postUrl, urldecode($json_data));                            $procResult = @json_decode($result['content'], true);                            $insert     = array(                                'cardid' => $reds['cardid'],                                'cardname' => $reds['cardname'],                                'cardtime' => TIMESTAMP,                                'cardstatus' => $procResult['errcode'],                                'cardmemo' => $procResult['errmsg']                            );                            pdo_update('bm_payx_payed', $insert, array(                                "clientOrderId" => $params['tid']                            ));                        }                    }                }                $result   = mc_credit_update($_W['fans'][uid], 'credit1', $reply['n']);                $url      = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(                    'cid' => $payed['clientOrderId']                ));                $template = array(                    'touser' => $_W['fans']['openid'],                    'template_id' => $reply['templateid1'],                    'url' => $url,                    'topcolor' => "#7B68EE",                    'data' => array(                        'first' => array(                            'value' => urlencode('感谢您使用' . $_W['account']['name'] . '扫码支付！'),                            'color' => "#743A3A"                        ),                        'keyword1' => array(                            'value' => urlencode($payed['clientOrderId']),                            'color' => "#FF0000"                        ),                        'keyword2' => array(                            'value' => urlencode(date('Y-m-d H:i:s', time())),                            'color' => "#0000FF"                        ),                        'keyword3' => array(                            'value' => urlencode($payed['qrmoney']),                            'color' => "#0000FF"                        ),                        'remark' => array(                            'value' => urlencode("付款码：" . $payed['paycode'] . "，点击详情查看账单！"),                            'color' => "#008000"                        )                    )                );                $x        = $this->send_template_message(urldecode(json_encode($template)), $access_token);                header('Location: ' . $url);                exit;            } else {                message($reply['qrerrormemo'], $reply['qrerrorurl'], 'success');            }        }        message($reply['memo'], $reply['urly'], 'success');    }    public function doMobileShow()    {        global $_W, $_GPC;        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        $rid   = trim($_GPC['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if (time() > strtotime($reply['endtime'])) {            if (empty($reply['memo2'])) {                $msg = '对不起，活动已经于' . $reply['endtime'] . '结束，感谢您的参与！！！';            } else {                $msg = $reply['memo2'];            }            message($msg, $reply['url2'], 'success');        }        if (time() < strtotime($reply['starttime'])) {            if (empty($reply['memo1'])) {                $msg = '对不起，活动将于' . $reply['starttime'] . '开始，敬请期待！！！';            } else {                $msg = $reply['memo1'];            }            message($msg, $reply['url1'], 'success');        }        if (empty($_W['fans']['nickname'])) {            mc_oauth_userinfo();        }        if ($reply['pictype'] == 1) {            if ((empty($_W['fans']['follow'])) || ($_W['fans']['follow'] == 0)) {                header("Location: " . $reply['urlx']);                exit;            }        }        $op        = trim($_GPC['op']);        $qrmoney   = $_GPC['qrmoney'];        $from_user = $_W['fans']['openid'];        $qrpicurl  = $_W['attachurl'] . $reply['qrcode'];        if ($op == 'post') {            if ($qrmoney < 0.01) {                message('支付金额错误，请重新录入！', $this->createMobileUrl('show', array(                    'rid' => $rid,                    'from_user' => $from_user                )), 'error');            }            $data = array(                'rid' => $rid,                'dateline' => TIMESTAMP,                'clientOrderId' => TIMESTAMP . random(6, 1),                'qrmoney' => $qrmoney,                'status' => 0,                'fromuser' => $from_user,                'username' => $_W['fans']['nickname'],                'avatar' => $_W['fans']['tag']['avatar'],                'credit' => $reply['n'],                'paycode' => random(6, 1)            );            pdo_insert('bm_payx_payed', $data);            $params = array(                'tid' => $data['clientOrderId'],                'ordersn' => $data['clientOrderId'],                'title' => '扫码支付',                'fee' => $data['qrmoney'],                'user' => $from_user            );            $this->pay($params);            exit;        } else {            if ($op == 'sign') {                $rec = pdo_fetch("select * from " . tablename('bm_payx_record') . " where rid= " . $rid . " and fromuser= '{$from_user}' order by sign_time desc");                if (!empty($rec)) {                    $Date_1       = date("Y-m-d", time());                    $Date_2       = date("Y-m-d", $rec['sign_time']);                    $Date_List_a1 = explode("-", $Date_1);                    $Date_List_a2 = explode("-", $Date_2);                    $d1           = mktime(0, 0, 0, $Date_List_a1[1], $Date_List_a1[2], $Date_List_a1[0]);                    $d2           = mktime(0, 0, 0, $Date_List_a2[1], $Date_List_a2[2], $Date_List_a2[0]);                    $Days         = round(($d1 - $d2) / 3600 / 24);                    if ($Days == 0) {                        $msg = '感谢您的参与，每个人每天只可以签到一次哦！！！';                        message($msg, $reply['urly'], 'success');                    }                }                $insert = array(                    'rid' => $rid,                    'fromuser' => $from_user,                    'username' => $_W['fans']['nickname'],                    'avatar' => $_W['fans']['tag']['avatar'],                    'sign_time' => $_W['timestamp'],                    'credit' => $reply['n']                );                pdo_insert('bm_payx_record', $insert);                $user       = fans_search($from_user);                $sql_member = "SELECT a.uid FROM " . tablename('mc_mapping_fans') . " a inner join " . tablename('mc_members') . " b on a.uid=b.uid WHERE b.uniacid='{$_W['uniacid']}' and a.openid='{$from_user}'";                $uid        = pdo_fetchcolumn($sql_member);                mc_credit_update($uid, 'credit1', intval($reply['n']), array(                    0 => 'system',                    1 => '扫码签到送积分'                ));                $user = fans_search($from_user);                message($reply['memo'], $reply['urly'], 'success');            }        }        include $this->template('show');    }    public function doMobilePayok()    {        global $_W, $_GPC;        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        $url   = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(            'rid' => $rid,            'payid' => $payed['id']        ));        $cid   = trim($_GPC['cid']);        $payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(            ':clientOrderId' => $cid        ));        $rid   = trim($payed['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        include $this->template('payok');    }    public function doMobilePayed()    {        global $_W, $_GPC;        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        $op    = trim($_GPC['op']);        $url   = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(            'rid' => $rid,            'payid' => $payed['id']        ));        $rid   = trim($_GPC['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if ($op == 'detail') {            $day = trim($_GPC['day']);            if (!empty($day)) {                $condition = " and date_format(FROM_UNIXTIME(paytime),'%Y-%m-%d')='{$day}'";            } else {                $condition = "";            }            $list              = pdo_fetchall("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(                ':rid' => $rid            ));            $totalsuccess      = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(                ':rid' => $rid            ));            $totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(                ':rid' => $rid            ));        } elseif ($op == 'day') {            $month = trim($_GPC['month']);            if (!empty($month)) {                $condition = " and date_format(FROM_UNIXTIME(paytime),'%Y-%m')='{$month}'";            } else {                $condition = "";            }            $list              = pdo_fetchall("SELECT date_format(FROM_UNIXTIME(paytime),'%Y-%m-%d') as day,count(*) as c,sum(qrmoney) as q,sum(red) as r FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition group by day ORDER BY day", array(                ':rid' => $rid            ));            $totalsuccess      = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(                ':rid' => $rid            ));            $totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 $condition ORDER BY `id` DESC", array(                ':rid' => $rid            ));        } elseif ($op == 'month') {            $list              = pdo_fetchall("SELECT date_format(FROM_UNIXTIME(paytime),'%Y-%m') as month,count(*) as c,sum(qrmoney) as q,sum(red) as r FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 group by month ORDER BY month", array(                ':rid' => $rid            ));            $totalsuccess      = pdo_fetchcolumn("SELECT count(*) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 ORDER BY `id` DESC", array(                ':rid' => $rid            ));            $totalsuccessmoney = pdo_fetchcolumn("SELECT sum(qrmoney) FROM " . tablename('bm_payx_payed') . " WHERE rid = :rid and status>0 ORDER BY `id` DESC", array(                ':rid' => $rid            ));        }        include $this->template('payed');    }    public function doMobilePaycheck()    {        global $_W, $_GPC;        $useragent = addslashes($_SERVER['HTTP_USER_AGENT']);        if (strpos($useragent, 'MicroMessenger') === false && strpos($useragent, 'Windows Phone') === false) {            message('非法访问，请通过微信打开！');            die();        }        $cid   = trim($_GPC['cid']);        $op    = trim($_GPC['op']);        $payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(            ':clientOrderId' => $cid        ));        $rid   = trim($payed['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        if ($op == 'used') {            $employee = pdo_fetch("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and from_user = :from_user ORDER BY `id` DESC", array(                ':weid' => $reply['weid'],                ':from_user' => $_W['fans']['openid']            ));            $insert   = array(                'from_user' => $_W['fans']['openid'],                'eid' => $employee['id'],                'status' => 2,                'name' => $employee['name'],                'usetime' => TIMESTAMP            );            pdo_update('bm_payx_payed', $insert, array(                "clientOrderId" => $cid            ));        } elseif ($op == 'payed') {            $employee = pdo_fetch("SELECT * FROM " . tablename('bm_payx_employee') . " WHERE weid = :weid and from_user = :from_user ORDER BY `id` DESC", array(                ':weid' => $reply['weid'],                ':from_user' => $_W['fans']['openid']            ));            $insert   = array(                'from_user' => $_W['fans']['openid'],                'eid' => $employee['id'],                'status' => 1,                'name' => $employee['name'],                'usetime' => TIMESTAMP            );            pdo_update('bm_payx_payed', $insert, array(                "clientOrderId" => $cid            ));        }        $url   = $_W['siteroot'] . 'app/' . $this->createMobileUrl('payok', array(            'rid' => $rid,            'payid' => $payed['id']        ));        $cid   = trim($_GPC['cid']);        $op    = trim($_GPC['op']);        $payed = pdo_fetch("SELECT * FROM " . tablename('bm_payx_payed') . " WHERE clientOrderId = :clientOrderId ORDER BY `id` DESC", array(            ':clientOrderId' => $cid        ));        $rid   = trim($payed['rid']);        $reply = pdo_fetch("SELECT * FROM " . tablename('bm_payx_reply') . " WHERE rid = :rid ORDER BY `id` DESC", array(            ':rid' => $rid        ));        include $this->template('paycheck');    }    private function get_rand($proArr)    {        $result = '';        $proSum = array_sum($proArr);        foreach ($proArr as $key => $proCur) {            $randNum = mt_rand(1, $proSum);            if ($randNum <= $proCur) {                $result = $key;                break;            } else {                $proSum -= $proCur;            }        }        unset($proArr);        return $result;    }}