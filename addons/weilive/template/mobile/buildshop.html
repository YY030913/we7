<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>添加店铺</title>
    <link rel="stylesheet" href="../addons/weilive/style/css/shop.css"/>
<script type="text/javascript">
function checkdata(){
	var pic_url=document.getElementById('pic_url').value;
	var pic_url1=document.getElementById('pic_url1').value;
	var shop_name=document.getElementById('shop_name').value;
	var mobilephone=document.getElementById('mobilephone').value;
	var Business_Hours=document.getElementById('Business_Hours').value;
	var place=document.getElementById('place').value;
	var location_c=document.getElementById('location_c').value;
	var location_a=document.getElementById('location_a').value;
	var big_type_id=document.getElementById('big_type_id').value;
	var small_type_id=document.getElementById('small_type_id').value;
	var describe=document.getElementById('describe').value;
	var pwd=document.getElementById('pwd').value;
	var emp = /^\s*$/;
	if(emp.test(shop_name)){
	alert("亲，请填写店铺名称！");
	return false;
	}else if(emp.test(pic_url1)){
	alert("亲，图片正在上传中，请稍候提交！");
	return false;
	}else if(emp.test(pic_url)){
	alert("亲，图片正在上传中，请稍候提交！");
	return false;
	}else if(emp.test(mobilephone)){
	alert("亲，请填写电话！");
	return false;
	}else if(emp.test(Business_Hours)){
	alert("亲，请填写营业时间！");
	return false;
	}else if(emp.test(location_c)||location_c==0){
	alert("亲，请选择区域！");
	return false;
	}else if(emp.test(location_a)||location_a==0){
	alert("亲，请选择商圈！");
	return false;
	
	}else if(emp.test(big_type_id)||big_type_id==0){
	alert("亲，请选择大分类！");
	return false;
	}else if(emp.test(small_type_id)||small_type_id==0){
	alert("亲，请选择小分类！");
	return false;
	}else if(emp.test(describe)){
	alert("亲，请填写店铺介绍！");
	return false;
	}else if(emp.test(pwd)){
	alert("亲，请填写消费密码！");
	return false;
	}else if(emp.test(place)){
	alert("亲，请填写店铺地址！");
	return false;
	}else{
	return true;
	}
}

function immediately(){ 
	var element = document.getElementById("place"); 
	if("\v"=="v") { 
		element.onpropertychange = webChange; 
	}else{ 
		element.addEventListener("input",webChange,false);
	} 
}
var ii = 1;
function webChange(){ 
 BodyOnLoad();
   /* var str = document.getElementById("place").value;
	if(str.length%5==0){
		str = str + '\n';
	}
	var hs = parseInt(str.split("\n").length);
	if(hs > ii){ 
		ii++;
		alert(hs);
	}
	*/
}
function BodyOnLoad() 
{ 
var textarea= document.getElementById("place"); 
textarea.style.posHeight=textarea.scrollHeight; 
} 

	</script>
	<style>
	.m-form .row input[type='tel'], .m-form .row .time {
		width: 100%;
		height: 34px;
		padding: 0 12px;
		border: 1px solid #e1e1e1;
		background-color: #fff;
		outline: none;
		-webkit-box-shadow: none;
		box-shadow: none;
		-webkit-border-radius: 5px;
		border-radius: 5px;
	}
	</style>
</head>
<body>
<div class="app-view">
    <div class="app-page">
        <header class="app-head">
            <div class="inner">
                <a class="link app-back" href="javascript:history.back();">
                    <i class="icon-back"></i>
                </a>
				<p style=" float:right;"><a href="{php echo $this->createMobileUrl('myshop', array('op'=>'exit'))}" class=""><input type="button" value="退出" name="" style="color:#666; width:60px; height:28px;"/></a></p>
                <h1 class="title sliding">创建店铺</h1>
            </div>
        </header>
        <section class="app-wrap">
            <div class="inner">	
                <form class="m-form" id="fr1" name="fr1" onSubmit="return checkdata();" action="{php echo $this->createMobileUrl('myshop', array('op'=>'post', 'hostid'=>$hostid));}" method="post">
					<div class="row">
                        <span class="tag">营业执照：</span>
						<input type="file" id="file1" name="file" accept="image/*">
						<input type='hidden' id='pic_url1' name='permit' value="{if empty($active['permit'])}{else}{$_W['attachurl']}{$active['permit']}{/if}"/>
						<label for="headUpload"><span id="aaa"></span><img style="display:block" id="fileimg1" src="{if empty($active['logo'])}../addons/weilive/style/images/home.png{else}{$_W['attachurl']}{$active['logo']}{/if}" width="120px;" class="hl-bdrs-16 fileimg"></label>
					</div>
					<div class="row">
                        <span class="tag">店铺图片：</span>
						<input type="file" id="file" name="file" accept="image/*">
						<input type='hidden' id='pic_url' name='logo' value="{if empty($active['logo'])}{else}{$_W['attachurl']}{$active['logo']}{/if}"/>
						<label for="headUpload"><span id="bbb"></span><img id="fileimg" style="display:block" src="{if empty($active['logo'])}../addons/weilive/style/images/home.png{else}{$_W['attachurl']}{$active['logo']}{/if}" width="120px;" class="hl-bdrs-16 fileimg"></label>
					</div>
					<div class="msg" style="margin-top:0; margin-bottom:0; margin-left:80px; color:red;">
                        建议图片为330px:220px
                    </div>
                    <div class="row">
                        <span class="tag">店铺名称：</span>
                        <input type="text" id="shop_name" name="title"/>
                    </div>
                    <div class="row">
                        <span class="tag">商家电话：</span>
                        <input type="tel" id="mobilephone" name="tel"/>
                    </div>
                    <div class="row">
                        <span class="tag">营业时间：</span>
                        <input type="tel" id="Business_Hours" name="business_time"/>
                    </div>
					<div class="row">
                        <span class="tag">选择区域：</span>
                        <select style="display:none;" name="location_p" id="location_p"></select>
						<select name="location_c" id="location_c" style="height:28px;" ></select>
						<select name="location_a" id="location_a" style="height:28px;" ></select>
						<script type="text/javascript" src="./../addons/weilive/style/js/region_select.js"></script>
						<script type="text/javascript">
							var location_p = "{if !empty($item['location_p'])}{$item['location_p']}{else}广西壮族自治区{/if}";
							var location_c = "{if !empty($item['location_c'])}{$item['location_c']}{else}柳州市{/if}";
							var location_a = "{if !empty($item['location_a'])}{$item['location_a']}{else}城中区{/if}";
							new PCAS("location_p", "location_c", "location_a", location_p, location_c, location_a);
						</script>
                    </div>
					<div class="row">
                        <span class="tag">选择分类：</span>
                       <select name="pcate" id="big_type_id" style="height:28px;" onChange="category(this.value)">
							<option value="0">选择大分类</option>
							{loop $categorys $c}
								<option value="{$c['id']}">{$c['name']}</option>
							{/loop}
					   </select>
					   <select name="ccate" id="small_type_id" style="height:28px;" >
							<option value="0">选择小分类</option>
					   </select>
                    </div>
					<div class="row">
                        <span class="tag">消费密码：</span>
                        <input type="tel" name="pwd" id="pwd" placeholder="如需修改请联系管理员"/>
                    </div>
                    <div class="row">
                        <span class="tag">店铺介绍：</span>
                        <textarea name="description" id="describe"></textarea>
                    </div>
					<div class="row">
                        <span class="tag">店铺地址：</span>
                        <textarea id="place" placeholder="输入地址快速搜索定位" name="place" data-rule-required="true" style="height:55px;width:70%;"/>{$item['place']}</textarea>
						<button style="position:relative;height:55px;width:55px;background-color:RGB(62,175,14);top:-21px;" id="positioning" type="button" onclick="bmap.searchMapByAddress($('#place').val())"><font color="white" size="4px">搜索</font></button>
                    </div>
					<style>
					.m-form .row1 {
						position: relative;
						min-height: 34px;
						margin-bottom: 6px;
						padding-left: 0px;
					}
					</style>
					<div class="row1">
						<div id="l-map" style="overflow: hidden; position: relative; z-index: 0; background-image: url(http://api.map.baidu.com/images/bg.png);width: 100%; height: 200px;margin-top: 10px; color: rgb(0, 0, 0); text-align: left;"></div>
						<span id="r-result">
							<input style="width:49%;" type="text" id="lat" name="lat"> <input style="width:49%;" type="text" id="lng" name="lng">
						</span>
					<div>
					<input type="hidden" name="token" value="{$_W['token']}" />
                    <input class="submit" name="submit" id="sub1" type="submit" value="提交">
                </form>
            </div>
        </section>
    </div>
</div>
</body>
<script src="../addons/weilive/style/js/jquery.1.11.1.js"></script>
<script type="text/javascript">
	<!--
	var categorys = {php echo json_encode($child)};
	//-->
</script>
<script type="text/javascript">
function category(cid) {
	var html = '<option value="0">选择小分类</option>';
	if (!categorys || !categorys[cid]) {
		$('#small_type_id').html(html);
		return false;
	}
	for (i in categorys[cid]) {
		html += '<option value="'+categorys[cid][i][0]+'">'+categorys[cid][i][1]+'</option>';
	}
	$('#small_type_id').html(html);
}
</script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=1.4&ak=&services=&t=20140102035142"></script>
<script type="text/javascript">
    $(function(){
        $(".location").change(function(){
            bmap.searchMapByPCD();
        });
    });
    new PCAS("location_p", "location_c", "location_a", location_p, location_c, location_a);
    var bmap = {
        'option' : {
            'lock' : false,
            'container' : 'l-map',
            'infoWindow' : {'width' : 250, 'height' : 100, 'title' : ''},
            'point' : {'lng' : "{if $item['lng']!='0.0000000000' && !empty($item['lng'])}{$item['lng']}{else}109.483181{/if}", 'lat' : "{if $item['lat']!='0.0000000000' && !empty($item['lat'])}{$item['lat']}{else}24.371128{/if}"}
        },
        'init' : function(option) {
            var $this = this;
            $this.option = $.extend({},$this.option,option);

            $this.option.defaultPoint = new BMap.Point($this.option.point.lng, $this.option.point.lat);
            $this.bgeo = new BMap.Geocoder();
            $this.bmap = new BMap.Map($this.option.container);
            $this.bmap.centerAndZoom($this.option.defaultPoint, 15);
            $this.bmap.enableScrollWheelZoom();
            $this.bmap.enableDragging();
            $this.bmap.enableContinuousZoom();
            $this.bmap.addControl(new BMap.NavigationControl());
            $this.bmap.addControl(new BMap.OverviewMapControl());
            //添加标注
            $this.marker = new BMap.Marker($this.option.defaultPoint);
            $this.marker.setLabel(new BMap.Label('请您移动此标记，选择您的坐标！', {'offset':new BMap.Size(10,-20)}));
            $this.marker.enableDragging();
            $this.bmap.addOverlay($this.marker);
            //$this.marker.setAnimation(BMAP_ANIMATION_BOUNCE);
            $this.showPointValue($this.marker.getPosition());
            //拖动地图事件
            $this.bmap.addEventListener("dragging", function() {
                $this.setMarkerCenter();
                $this.option.lock = false;
            });
            //缩入地图事件
            $this.bmap.addEventListener("zoomend", function() {
                $this.setMarkerCenter();
                $this.option.lock = false;
            });
            //拖动标记事件
            $this.marker.addEventListener("dragend", function (e) {
                $this.showPointValue();
                $this.showAddress();
                $this.bmap.panTo(new BMap.Point(e.point.lng, e.point.lat));
                $this.option.lock = false;
                $this.marker.setAnimation(null);
            });
        },
        'searchMapByAddress' : function(address) {
            var $this = this;
            $this.bgeo.getPoint(address, function (point) {
                if (point) {
                    $this.showPointValue();
                    $this.showAddress();
                    $this.bmap.panTo(point);
                    $this.setMarkerCenter();
                }
            });
        },
        'searchMapByPCD' : function(address) {
            //alert($('#location_p').val()+$('#location_c').val()+$('#location_a').val());
            var $this = this;
            $this.option.lock = true;
            $this.searchMapByAddress($('#location_p').val()+$('#location_c').val()+$('#location_a').val());
        },
        'setMarkerCenter' : function() {
            var $this = this;
            var center = $this.bmap.getCenter();
            $this.marker.setPosition(new BMap.Point(center.lng, center.lat));
            $this.showPointValue();
            $this.showAddress();
        },
        'showPointValue' : function() {
            var $this = this;
            var point = $this.marker.getPosition();
            $('#lng').val(point.lng);
            $('#lat').val(point.lat);
        },
        'showAddress' : function() {
            var $this = this;
            var point = $this.marker.getPosition();
            $this.bgeo.getLocation(point, function (s) {
                if (s) {
                    $('#place').val(s.address);
                    if (!$this.option.lock) {
                        //cascdeInit(s.addressComponents.province,s.addressComponents.city,s.addressComponents.district);
                        new PCAS("location_p", "location_c", "location_a", s.addressComponents.province, s.addressComponents.city, s.addressComponents.district);
                    }
                }
            });
        }
    };
    $(function(){
        var option = {};
        bmap.init(option);
    });</script>
<script src="../addons/weilive/style/js/zepto.min.js"></script>
<script type="text/javascript" src="../addons/weilive/style/js/zepto.form.js"></script>
	<script type="text/javascript">		
		//图片上传
		var btn = $("body");
	
		$("#file").wrap('<form method="post" id="formUpload" action="{php echo $this->createMobileUrl('UploadImage');}" enctype="multipart/form-data"></form>');			
		$("#file").change(function(){
			document.getElementById('fileimg').style.display = 'none';
			document.getElementById('bbb').innerHTML = '正在上传，请耐心等候...';
			$("#formUpload").ajaxSubmit({
				dataType:  'json',
				beforeSend: function() {
				},
				uploadProgress: function(event, position, total, percentComplete) {
			
				},
				success: function(data) {
					
					if(data.error==1) {
						
					}else{
						var pic_url = data.filename;
						$('#fileimg').attr('src','{$_W['attachurl']}'+pic_url);
						$('#pic_url').attr('value',pic_url);
						document.getElementById('fileimg').style.display = 'block';
						document.getElementById('bbb').innerHTML = '';
						//window.location.href='cut?path='+data;
					}
				},
				error:function(xhr){
					btn.html("上传失败了");
				}
			});
		});
		$("#file1").wrap('<form method="post" id="formUpload1" action="{php echo $this->createMobileUrl('UploadImage');}" enctype="multipart/form-data"></form>');			
		$("#file1").change(function(){
			document.getElementById('fileimg1').style.display = 'none';
			document.getElementById('aaa').innerHTML = '正在上传，请耐心等候...';
			$("#formUpload1").ajaxSubmit({
				dataType:  'json',
				beforeSend: function() {
				},
				uploadProgress: function(event, position, total, percentComplete) {
			
				},
				success: function(data) {
					
					if(data.error==1) {
						
					}else{
						var pic_url = data.filename;
						$('#fileimg1').attr('src','{$_W['attachurl']}'+pic_url);
						$('#pic_url1').attr('value',pic_url);
						document.getElementById('fileimg1').style.display = 'block';
						document.getElementById('aaa').innerHTML = '';
						//window.location.href='cut?path='+data;
					}
				},
				error:function(xhr){
					btn.html("上传失败了");
				}
			});
		});
</script>
</html>